# Virtual Ecosystem simulation flow

:::{warning}
This section is outdated and is being retained while the information is moved into new
homes.
:::

## Model configuration

The loaded configuration should include the configuration details for each individual
science model. These are now used to initialise each requested model using the
{meth}`~virtual_ecosystem.core.base_model.BaseModel.from_config` method defined
for each model. This method checks that the configuration is valid for the science
model.

## Model setup

Some models require an additional setup step to calculate values for internal variables
from the initial loaded data or to set up further structures within the model, such as
representations of plant or animal communities. Each model will run the
{meth}`~virtual_ecosystem.core.base_model.BaseModel.setup` method defined for the
specific model. In simple science models, this method may not actually need to do
anything.

## Model spinup

Some models may then require a spin up step to allow initial variables to reach an
equilibrium before running the main simulation. Again, each model will run the
{meth}`~virtual_ecosystem.core.base_model.BaseModel.spinup` method defined for the
specific model, and again this may not need to do anything for simple models.

## Model update

At this point, the model instance is now ready for simulation. The
{meth}`~virtual_ecosystem.core.base_model.BaseModel.update` method for each science
model is run as part of the simulation process described below.

## Simulation process

Now that the simulation core and science models have been configure and initialised,
along with any setup or spinup steps, the simulation itself starts.

### Saving the initial state

The `data` object has now been populated with all of the configured data required to run
the model. The simulation configuration can optionally provide a filepath that will be
used to output a single data file of the initial simulation state.

### Simulation

The science models are now iterated over the configured simulation timescale, running
from the start time to the end time with a time step set by the update interval. At each
step all models are updated. If the simulation has been configured to output continuous
data, the relevant variables will also be saved.

### Saving the final state

After the full simulation loop has been completed, the final simulation state held in
the `Data` object can be optionally be saved to a path provided in the configuration,
defaulting to saving the data.

### Combining continuous data

If the model has been set up to output continuous time data, then there is a final step
to combine the output files into a single file. This step is required as the continuous
data is saved at every time step, resulting in a large number of files. Continuous data
files are found by searching the output folder for files matching the pattern
`"continuous_state*.nc"`. All these files are loaded, combined into a single dataset,
and then deleted. This combined dataset is then saved in the output folder with the file
name `"all_continuous_data.nc"`.

```{warning}
The function to combine the continuous data files reads in **all** files in the
specified output folder that match the pattern `"continuous_state*.nc"`. If a file is
included that matches this pattern but was not generated by the current simulation, the
complete continuous data file will end up either being corrupted or containing incorrect
information. In addition to this, the spurious files will likely be deleted.
```
